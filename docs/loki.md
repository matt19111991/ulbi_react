## Loki

Инструмент скриншотного тестирования `Storybook`. Часть регрессионного тестирования.
Позволяет сравнивать предыдущую верстку с текущей

### Инициализация

После установки `loki` как `devDependency`, необходима инициализация с указанием пути к конфигу `Storybook`:

`npx loki init --config ./config/storybook`

### Запуск

Флаг `--requireReference` - выдает ошибку для `stories` без изображений, используется для `CI`

Флаг `--reactUri` - путь до статического билда, используется для `CI`

`reg-cli` - инструмент для визуального регрессионного тестирования с `HTML-репортером`

### Скрипты

Запуск скриншотного тестирования с `Loki` (на выходе скриншоты в папке `./loki`):

    npm run test:ui

Подтверждение новых скриншотов `Loki`:

    npm run test:ui:ok

Запуск скриншотных тестов `Loki` для `CI` (используется билд **Storybook**):

    npm run test:ui:ci

Генерация `JSON` с различиями между скриншотами `Loki`:

    npm run test:ui:json

Генерация `HTML` страницы на базе `JSON` файла с различиями между скриншотами `Loki`:

    npm run test:ui:html

Генерация полного отчета (`JSON` и `HTML`) для скриншотных тестов `Loki`:

    npm run test:ui:report

Обновление скриншотных тестов `Loki`:

    npm run test:ui:update

### Настройки

В `package.json` можно задавать:
- механизм сверки скриншотов:
    - `pixelmatch`: быстрый (по умолчанию, хорош для больших общих изображений)
    - `gm`: средний (требует установки дополнительных модулей)
    - `looks-same`: медленный (для более точного и детального сравнения изображений)
      - `ignoreCaret: true` - игнорируем курсор в инпутах,
                              мерцание курсора может создавать проблемы при сравнении скриншотов
      - `strict: false` - отключаем строгий режим

- устройства:
    - `chrome.laptop`
    - `chrome.iphone7`

- `target` (при помощи какого приложения будет запускаться):
    - `chrome.docker`
    - `chrome.app`

### Проблемы

Имеются проблемы с работой под `Windows`.

`Loki` не работает напрямую со `Storybook v.7+`

`cross-env NODE_OPTIONS=--no-warnings` добавляем при запуске, чтобы избежать всех типов предупреждений

Необходимо свойство `overrides` в `package.json` с указанием последних версий `@storybook/react` и
других библиотек, чтобы избавиться от ошибок и предупреждений при установке модулей
